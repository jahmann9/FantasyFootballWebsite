<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Head-to-Head & Career Totals Report</title>
  <style>
    body{font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; margin:20px; background:#0f172a; color:#e6eef8}
    .container{max-width:1100px;margin:0 auto}
    h1,h2{color:#fff}
    .controls{display:flex;gap:10px;margin-bottom:12px}
    textarea{width:100%;height:160px;padding:8px;border-radius:6px;border:1px solid #334155;background:#071025;color:#e6eef8}
    button{background:#06b6d4;border:none;padding:10px 14px;border-radius:8px;color:#021124;cursor:pointer;font-weight:600}
    button.secondary{background:#94a3b8;color:#04212b}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:8px;border-bottom:1px solid #1f2937;text-align:left}
    th{background:#0b1220;color:#9fb6c9;position:sticky;top:0}
    th.sortable{cursor:pointer;user-select:none;position:relative}
    th.sortable:hover{background:#1a2332}
    th.sortable::after{content:'↕';margin-left:8px;opacity:0.5;font-size:0.8em}
    th.sortable.asc::after{content:'↑';opacity:1}
    th.sortable.desc::after{content:'↓';opacity:1}
    tr:hover td{background:#071827}
    .pf{color:#7ee787} .pa{color:#ffb4b4}
    .card{background:linear-gradient(180deg,#071025 0%, #041325 100%);padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(2,6,23,0.6);margin-bottom:14px}
    .player-row{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;margin-bottom:6px}
    .opp-list{margin-top:8px}
    .opp-item{display:flex;justify-content:space-between;padding:8px;border-radius:6px;margin-bottom:6px;background:#021122}
    .small{font-size:0.9rem;color:#9fb6c9}
    .muted{color:#7b8794}
    .no-data{color:#f97316}
    details{margin-bottom:8px}
    summary{cursor:pointer;padding:8px;border-radius:6px;background:#031022}
  </style>
</head>
<body>
  <div class="container">
    <h1>Head-to-Head & Career Totals Report</h1>
    <p class="muted">Paste the JSON output from your Python script (see top comments for format) then click "Render report".</p>

    <div class="card">
      <div class="controls">
        <button id="renderBtn">Render report</button>
        <button id="clearBtn" class="secondary">Clear</button>
        <button id="resetBtn" class="secondary">Reset to default</button>
        <button id="sampleBtn" class="secondary">Load sample data</button>
      </div>
      <textarea id="jsonInput" placeholder='Paste JSON here'></textarea>
    </div>

    <div id="report"></div>
  </div>

<script>
function render(data){
  const container = document.getElementById('report');
  container.innerHTML = '';
  if(!data){container.innerHTML = '<p class="no-data">No data provided.</p>';return}

  const career = data.career_totals || data.careerTotals || [];
  const h2h = data.head_to_head || data.headToHead || data.headToHeadRecords || {};

  // Career totals table
  const careerCard = document.createElement('div');
  careerCard.className = 'card';
  careerCard.innerHTML = '<h2>Career Totals</h2>';
  const table = document.createElement('table');
  table.id = 'careerTable';
  const thead = document.createElement('thead');
  thead.innerHTML = `<tr>
    <th class="sortable" data-column="name" data-type="string">Player</th>
    <th class="sortable" data-column="wins" data-type="number">W-L</th>
    <th class="sortable" data-column="winningPercentage" data-type="number">%</th>
    <th class="sortable" data-column="pointsFor" data-type="number">PF</th>
    <th class="sortable" data-column="pointsAgainst" data-type="number">PA</th>
    <th class="sortable" data-column="avgPointsFor" data-type="number">Avg PF</th>
    <th class="sortable" data-column="avgPointsAgainst" data-type="number">Avg PA</th>
  </tr>`;
  table.appendChild(thead);
  const tbody = document.createElement('tbody');
  tbody.id = 'careerTableBody';

  // Store original data for sorting
  window.careerData = [...career];
  
  // Sort by wins initially (descending)
  career.sort((a,b)=>b.wins - a.wins);
  renderCareerTableRows(career, tbody);
  
  table.appendChild(tbody);
  careerCard.appendChild(table);
  container.appendChild(careerCard);

  // Add sort event listeners
  setupTableSorting();

  // Head-to-head section
  const h2hCard = document.createElement('div');
  h2hCard.className = 'card';
  h2hCard.innerHTML = '<h2>Head-to-Head Records</h2>';

  const players = Object.keys(h2h);
  if(players.length===0){
    h2hCard.innerHTML += '<p class="muted">No head-to-head data found.</p>';
  } else {
    players.sort((a,b)=>a.localeCompare(b));
    players.forEach(player => {
      const details = document.createElement('details');
      const summary = document.createElement('summary');
      summary.innerHTML = `<strong>${escapeHtml(player)}</strong> <span class='small muted'>click to expand</span>`;
      details.appendChild(summary);

      const opps = h2h[player];
      // convert to array and sort by wins desc
      const oppArray = Object.keys(opps).map(k=>({name:k,record:opps[k]})).sort((x,y)=> (y.record.wins||0) - (x.record.wins||0));

      const list = document.createElement('div');
      list.className = 'opp-list';
      oppArray.forEach(item=>{
        const r = item.record;
        const games = (r.wins||0) + (r.losses||0);
        if(games===0) return; // skip
        const div = document.createElement('div');
        div.className = 'opp-item';
        div.innerHTML = `<div><strong>${escapeHtml(item.name)}</strong><div class='small muted'>${r.wins||0}-${r.losses||0} (${Math.round(((r.wins||0)/games)*10000)/100}%)</div></div>
                         <div style='text-align:right'><div class='pf'>PF: ${r.pointsFor||0}</div><div class='pa'>PA: ${r.pointsAgainst||0}</div></div>`;
        list.appendChild(div);
      });
      details.appendChild(list);
      h2hCard.appendChild(details);
    });
  }

  container.appendChild(h2hCard);
}

// Function to render career table rows
function renderCareerTableRows(data, tbody) {
  tbody.innerHTML = '';
  data.forEach(p=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td><strong>${escapeHtml(p.name||p.player||p.owner||'Unknown')}</strong></td>
      <td>${p.wins||0}-${p.losses||0}</td>
      <td>${(p.winningPercentage!==undefined)?p.winningPercentage+'%':''}</td>
      <td class='pf'>${p.pointsFor||0}</td>
      <td class='pa'>${p.pointsAgainst||0}</td>
      <td>${p.avgPointsFor||0}</td>
      <td>${p.avgPointsAgainst||0}</td>`;
    tbody.appendChild(tr);
  });
}

// Function to setup table sorting
function setupTableSorting() {
  const table = document.getElementById('careerTable');
  if (!table) return;
  
  const headers = table.querySelectorAll('th.sortable');
  let currentSort = { column: 'wins', direction: 'desc' };
  
  // Set initial sort indicator
  const initialHeader = table.querySelector(`th[data-column="${currentSort.column}"]`);
  if (initialHeader) {
    initialHeader.classList.add(currentSort.direction);
  }
  
  headers.forEach(header => {
    header.addEventListener('click', () => {
      const column = header.dataset.column;
      const type = header.dataset.type;
      
      // Remove sort classes from all headers
      headers.forEach(h => h.classList.remove('asc', 'desc'));
      
      // Determine sort direction
      let direction = 'asc';
      if (currentSort.column === column && currentSort.direction === 'asc') {
        direction = 'desc';
      }
      
      // Add sort class to current header
      header.classList.add(direction);
      
      // Sort the data
      const sortedData = sortTableData([...window.careerData], column, direction, type);
      
      // Re-render the table body
      const tbody = document.getElementById('careerTableBody');
      renderCareerTableRows(sortedData, tbody);
      
      // Update current sort
      currentSort = { column, direction };
    });
  });
}

// Function to sort table data
function sortTableData(data, column, direction, type) {
  return data.sort((a, b) => {
    let aVal = a[column];
    let bVal = b[column];
    
    // Handle special cases
    if (column === 'name') {
      aVal = a.name || a.player || a.owner || 'Unknown';
      bVal = b.name || b.player || b.owner || 'Unknown';
    }
    
    // Convert to appropriate type
    if (type === 'number') {
      aVal = parseFloat(aVal) || 0;
      bVal = parseFloat(bVal) || 0;
    } else {
      aVal = String(aVal).toLowerCase();
      bVal = String(bVal).toLowerCase();
    }
    
    // Sort logic
    if (aVal < bVal) return direction === 'asc' ? -1 : 1;
    if (aVal > bVal) return direction === 'asc' ? 1 : -1;
    return 0;
  });
}

function escapeHtml(s){return String(s).replace(/[&<>\"']/g, function(m){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m]})}

// Global variable to store the default data
let defaultData = null;

// Load the default league summary data
async function loadDefaultData() {
  try {
    const response = await fetch('league_summary.json');
    if (!response.ok) throw new Error('Failed to load league_summary.json');
    defaultData = await response.json();
    return defaultData;
  } catch (error) {
    console.error('Error loading default data:', error);
    // Fallback to sample data if league_summary.json is not available
    defaultData = getSampleData();
    return defaultData;
  }
}

// Get sample data
function getSampleData() {
  return {
    career_totals:[
      {name:'Jaron Ahmann',wins:12,losses:3,pointsFor:2000,pointsAgainst:1500,avgPointsFor:100,avgPointsAgainst:75,winningPercentage:80},
      {name:'Jacob Maxfield',wins:8,losses:7,pointsFor:1600,pointsAgainst:1550,avgPointsFor:88.9,avgPointsAgainst:86.1,winningPercentage:53.33}
    ],
    head_to_head:{
      'Jaron Ahmann':{
        'Jacob Maxfield':{wins:7,losses:3,pointsFor:700,pointsAgainst:650},
        'Bo Kitrell':{wins:5,losses:5,pointsFor:600,pointsAgainst:610}
      },
      'Jacob Maxfield':{
        'Jaron Ahmann':{wins:3,losses:7,pointsFor:650,pointsAgainst:700}
      }
    }
  };
}

// Initialize the page with default data
async function initializePage() {
  const data = await loadDefaultData();
  if (data) {
    document.getElementById('jsonInput').value = JSON.stringify(data, null, 2);
    render(data);
  }
}

// Wire up controls
document.getElementById('renderBtn').addEventListener('click', ()=>{
  const txt = document.getElementById('jsonInput').value.trim();
  if(!txt){alert('Paste JSON into the box first.');return}
  try{
    const data = JSON.parse(txt);
    render(data);
  }catch(e){alert('Invalid JSON: '+e.message)}
});

document.getElementById('clearBtn').addEventListener('click', ()=>{
  document.getElementById('jsonInput').value=''; document.getElementById('report').innerHTML='';
});

document.getElementById('resetBtn').addEventListener('click', ()=>{
  if (defaultData) {
    document.getElementById('jsonInput').value = JSON.stringify(defaultData, null, 2);
    render(defaultData);
  } else {
    alert('Default data not available');
  }
});

document.getElementById('sampleBtn').addEventListener('click', ()=>{
  const sample = getSampleData();
  document.getElementById('jsonInput').value = JSON.stringify(sample, null, 2);
});

// Initialize the page when it loads
document.addEventListener('DOMContentLoaded', initializePage);

</script>
</body>
</html>
